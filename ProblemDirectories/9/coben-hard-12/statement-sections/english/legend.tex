\textbf{This is the hard version of the problem. The only difference between the two versions is the time limit, constraints on $n$, and that ties are permitted. You can make hacks only if both versions of the problem are solved.}

\textbf{Amog} the Mogger enters the \textbf{Moniforces} into a multiplayer Nim tournament. However, they don't know the optimal strategy and thus play no better than random. 

You are given $n$ players with their current scores $p_1, p_2, \ldots, p_n$ and $n$ non-negative bonuses $s_1, s_2, \ldots, s_n$. In the next round, each player will randomly receive one of the bonuses. The player with the lowest total score after the round will be eliminated. \textbf{In the event of a tie for the lowest total score among $k$ players, one of them is eliminated uniformly at random, with each having a probability of $\frac{1}{k}$.}

Your task is to calculate, for each player $i$, the exact probability of being eliminated after the next round, returned modulo $998244353$.